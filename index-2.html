<!doctype html>
<html lang="en">

<head>
    <title>ztyr</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="https://unpkg.com/dropbox/dist/DropboxTeam-sdk.min.js"></script>
    <script>
      (function (root, factory) {
        'use strict';
        if (typeof define === 'function' && define.amd) {
          // AMD
          define(factory);
        } else if (typeof exports === 'object') {
          // Node, CommonJS-like
          module.exports = factory();
        } else {
          // Browser globals (root is window)
          root[root.__dropbox_export || 'dropbox'] = factory();
        }
      }(this, function () {
        'use strict';

        var toString = ({}).toString;

        function isFunction(x, type) {
          return toString.call(x) == '[object Function]';
        }

        function isString(x, type) {
          return toString.call(x) == '[object String]';
        }

        function isObject(x, type) {
          return toString.call(x) == '[object Object]';
        }

        function paramsFromUrlHash() {
          return window.location.hash.replace(/^#/, '').split('&').reduce(function (o, entry) {
            if (entry == '') return o;
            entry = entry.split('=');
            o[decodeURIComponent(entry[0])] = decodeURIComponent(entry[1]);
            return o;
          }, {});
        }


        var api = 'https://api.dropboxapi.com/2/',
          content = 'https://content.dropboxapi.com/2/',
          tokenStore = function (key, val) {
            return (arguments.length > 1) ? (localStorage[key] = val) : localStorage[key];
          },
          globalErrorHandler = undefined;

        var endpointMapping = {
          'auth/token/revoke': { contentType: null },
          'files/upload': { baseUri: content, format: 'content-upload' },
          'files/get_thumbnail': { baseUri: content, format: 'content-download' },
          'files/download': { baseUri: content, format: 'content-download' },
          'files/get_preview': { baseUri: content, format: 'content-download' },
          'files/upload_session/append': { baseUri: content, format: 'content-upload' },
          'files/upload_session/append_v2': { baseUri: content, format: 'content-upload' },
          'files/upload_session/finish': { baseUri: content, format: 'content-upload' },
          'files/upload_session/start': { baseUri: content, format: 'content-upload' },
          'files/get_shared_link_file': { baseUri: content, format: 'content-download' }
        }
        var contentTypeMapping = {
          'rpc': 'application/json',
          'content-upload': 'application/octet-stream'
        }

        var dropbox = function (endpoint, apiArgs) {
          var args = [].slice.call(arguments);

          var config = endpointMapping[endpoint] || {},
            baseUri = config.baseUri || api,
            format = config.format || 'rpc',
            contentType = config.contentType || (config.contentType === null) ? null : contentTypeMapping[format];

          var lastArg = args[args.length - 1];
          var handlers = (args.length > 2 && (isObject(lastArg) || isFunction(lastArg))) ? lastArg : {};
          if (isFunction(handlers)) handlers = { onComplete: handlers };

          var promise, promisectl = {};
          if (Promise) {
            promise = new Promise(function (resolve, reject) {
              promisectl.resolve = resolve;
              promisectl.reject = reject
            });
          }

          var r = new XMLHttpRequest();

          r.open('POST', baseUri + endpoint, true);
          r.setRequestHeader('Authorization', 'Bearer ' + (tokenStore('__dbat') || '000000000000000000000000_00000-000000000000000000000000000000000'));

          if (format == 'content-download') r.responseType = 'blob';
          if (apiArgs && apiArgs.responseType) {
            r.responseType = apiArgs.responseType;
            delete apiArgs.responseType;
          }

          if (contentType) r.setRequestHeader('Content-Type', contentType);
          if (apiArgs && (format == 'content-upload' || format == 'content-download'))
            r.setRequestHeader('Dropbox-API-Arg', JSON.stringify(apiArgs));

          if (handlers.onDownloadProgress) r.addEventListener("progress", handlers.onDownloadProgress);
          if (handlers.onUploadProgress && r.upload) r.upload.addEventListener("progress", handlers.onUploadProgress);
          if (handlers.onError || globalErrorHandler) r.addEventListener("error", function (e) {
            var er = handlers.onError && handlers.onError(e.target);
            promise && promisectl.reject && promisectl.reject(e.target);
            globalErrorHandler && globalErrorHandler(e.target, er);
          });

          r.onreadystatechange = function () {
            if (r.readyState != 4) return;
            if (r.status == 200) {
              var apiResponse = JSON.parse(r.getResponseHeader('dropbox-api-result') || r.responseText);
              if (endpoint == 'auth/token/revoke') tokenStore('__dbat', '');
              handlers.onComplete && handlers.onComplete(apiResponse, r.response, r);
              promise && promisectl.resolve && promisectl.resolve(apiResponse, r.response, r);
            } else {
              var er = handlers.onError && handlers.onError(r);
              promise && promisectl.reject && promisectl.reject(r);
              globalErrorHandler && globalErrorHandler(r, er);
            }
          };

          var requestPayload = (args.length > 2 && format == 'content-upload') ? args[2] : undefined;
          requestPayload = requestPayload || ((apiArgs && format == 'rpc') ? JSON.stringify(apiArgs) : null);
          if (requestPayload) {
            r.send(requestPayload);
          } else {
            r.send();
          }

          return promise;
        }


        dropbox.setGlobalErrorHandler = function (handler) {
          globalErrorHandler = handler;
        }
        dropbox.setTokenStore = function (store) {
          tokenStore = store;
        },
          dropbox.authenticate = function (apiArgs, handlers) {
            handlers = handlers || {};
            if (isFunction(handlers)) handlers = { onComplete: handlers };
            apiArgs = apiArgs || {};
            if (isString(apiArgs)) apiArgs = { client_id: apiArgs };
            apiArgs.redirect_uri = apiArgs.redirect_uri || window.location.href;

            var promise, promisectl = {};
            if (Promise) {
              promise = new Promise(function (resolve, reject) {
                promisectl.resolve = resolve;
                promisectl.reject = reject
              });
            }

            // if we already have an access token, return immediately
            if (tokenStore('__dbat')) {
              handlers.onComplete();
              promise && promise.resolve && promise.resolve();
              return promise
            }

            var params = paramsFromUrlHash(),
              csrfToken = tokenStore('__dbcsrf');

            if (params.state && csrfToken && params.state == csrfToken) {
              // we are returning from authentication redirect
              if (params.access_token) {
                // the authentcation was successful
                tokenStore('__dbat', params.access_token);
                tokenStore('__dbcsrf', '');
                window.location.replace(window.location.href.replace(/#.*/, ''));
              } else {
                // the authentication was not successful
                var er = handlers.onError && handlers.onError(params);
                promise && promise.reject && promise.reject(params);
                globalErrorHandler && globalErrorHandler(params, er);
              }
            } else {
              // initiate authentication
              var csrfToken = "" + Math.floor(Math.random() * 100000);
              tokenStore('__dbcsrf', csrfToken);

              window.location = "https://www.dropbox.com/1/oauth2/authorize?response_type=token&"
                + "client_id=" + encodeURIComponent(apiArgs.client_id) + "&"
                + "redirect_uri=" + encodeURIComponent(apiArgs.redirect_uri) + "&"
                + "state=" + encodeURIComponent(csrfToken);
            }

            return promise;
          }

        return dropbox;
      }));

    </script>
</head>

<body>
<!-- Example layout boilerplate -->
<header class="page-header">
    <div class="container">
        <nav>
            <a href="/">
                <h1>
                    <img src="https://cfl.dropboxstatic.com/static/images/brand/logotype_white-vflRG5Zd8.svg"
                         class="logo" alt="dropbox"/>
                    JavaScript SDK Examples
                </h1>
            </a>
            <a href="https://github.com/dropbox/dropbox-sdk-js/tree/master/examples/javascript"
               class="view-source">View Source</a>
        </nav>
        <h2 class="code">
            <a href="/">examples</a> / authentication
        </h2>
    </div>
</header>

<div class="container main">
    <div><span>rev.3</span></div>
    <div id="pre-auth-section" style="display:none;">
        <p>This example takes the user through Dropbox's API OAuth flow using
            <code>Dropbox.getAuthenticationUrl()</code> method [<a
                    href="http://dropbox.github.io/dropbox-sdk-js/Dropbox.html#getAuthenticationUrl">docs</a>] and then
            uses the generated access token to list the contents of their root directory.</p>
        <a href="" id="authlink" class="button">Authenticate</a>
        <p class="info">Once authenticated, it will use the access token to list the files in your root directory.
        </p>
    </div>

    <div id="authed-section" style="display:none;">
        <p>You have successfully authenticated. Below are the contents of your root directory. They were fetched
            using the SDK and access token.</p>
        <ul id="files"></ul>
    </div>
</div>

<script>
  // ---
  // app key
  var ZTYR_CLIENT_ID = 'wcxza76xbwxv0aj';
  var ZTYR_REDIRECT_URI = 'https://surrsoft.github.io/ztyr/';

  // --- utils
  function parseQueryString(str) {
    var ret = Object.create(null);

    if (typeof str !== 'string') {
      return ret;
    }

    str = str.trim().replace(/^(\?|#|&)/, '');

    if (!str) {
      return ret;
    }

    str.split('&').forEach(function (param) {
      var parts = param.replace(/\+/g, ' ').split('=');
      // Firefox (pre 40) decodes `%3D` to `=`
      // https://github.com/sindresorhus/query-string/pull/37
      var key = parts.shift();
      var val = parts.length > 0 ? parts.join('=') : undefined;

      key = decodeURIComponent(key);

      // missing `=` should be `null`:
      // http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
      val = val === undefined ? null : decodeURIComponent(val);

      if (ret[key] === undefined) {
        ret[key] = val;
      } else if (Array.isArray(ret[key])) {
        ret[key].push(val);
      } else {
        ret[key] = [ret[key], val];
      }
    });

    return ret;
  }

  // --- dropbox
  /**
   * Get content of file (1) as promise
   *
   * @param pFilePath -- example '/tmp.txt'
   * @param pAccessToken -- example 'Ftf9IKaGJ-gAAAAAAAB7ZAoYY5nEgAUv2pfoBWjpV2UO4P_uSVcbbBBX1azdXSt2'
   * @returns {Promise<string | never>}
   */
  function dropboxFileContentDownload(pFilePath, pAccessToken) {
    return fetch('https://content.dropboxapi.com/2/files/download', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${pAccessToken}`,
        'Dropbox-API-Arg': JSON.stringify({ path: pFilePath }),
      }
    })
      .then(function (response) {
        console.log('response', response); // del+
        return response.text();
      })
      .then(function (textResp) {
        console.log('** textResp\n', textResp); // del+
        return textResp;
      })
      .catch(function (err) {
        console.log('ERR*', err);
      });
  }

  function dropboxFileContentUpload(pFilePath, pAccessToken) {

  }

  // ---
  // Парсит URL и получает их него access token если он есть в urls hash
  // Parses the url and gets the access token if it is in the urls hash
  function getAccessTokenFromUrl() {
    return parseQueryString(window.location.hash).access_token;
  }

  // Если пользователь просто перенаправлен с аутентификации, urls hash будет содержать access token
  // If the user was just redirected from authenticating, the urls hash will contain the access token.
  function isAuthenticated() {
    return !!getAccessTokenFromUrl();
  }

  // Наполнение элементами #files
  // Render a list of items to #files
  function renderItems(items) {
    var filesContainer = document.getElementById('files');
    items.forEach(function (item) {
      var li = document.createElement('li');
      li.innerHTML = item.name;
      filesContainer.appendChild(li);
    });
  }

  // This example keeps both the authenticate and non-authenticated setions
  // in the DOM and uses this function to show/hide the correct section.
  function showPageSection(elementId) {
    document.getElementById(elementId).style.display = 'block';
  }

  if (isAuthenticated()) {
    showPageSection('authed-section');
    // ---
    console.log('REV*', '14'); // del+
    console.log('** dropbox', dropbox);

    var accessToken = getAccessTokenFromUrl();
    console.log('!!-!!-!! accessToken {200321213403}\n', accessToken); //del+
    var filePath = '/tmp.txt';

    dropboxFileContentDownload(filePath)
      .then(function (textResp) {
        console.log('** textResp (2) \n', textResp)
      })

  } else {
    showPageSection('pre-auth-section');

    // Set the login anchors href using dbx.getAuthenticationUrl()
    var dbx = new Dropbox.Dropbox({ clientId: ZTYR_CLIENT_ID });
    var authUrl = dbx.getAuthenticationUrl(ZTYR_REDIRECT_URI);
    document.getElementById('authlink').href = authUrl;
  }
</script>
</body>

</html>
