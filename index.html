<!doctype html>
<html lang="en">

<head>
    <title>ztyr</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <script src="https://unpkg.com/dropbox/dist/DropboxTeam-sdk.min.js"></script>
</head>

<body>
<!-- Example layout boilerplate -->
<header class="page-header">
    <div class="container">
        <nav>
            <a href="/">
                <h1>
                    <img src="https://cfl.dropboxstatic.com/static/images/brand/logotype_white-vflRG5Zd8.svg"
                         class="logo" alt="dropbox"/>
                    JavaScript SDK Examples
                </h1>
            </a>
            <a href="https://github.com/dropbox/dropbox-sdk-js/tree/master/examples/javascript"
               class="view-source">View Source</a>
        </nav>
        <h2 class="code">
            <a href="/">examples</a> / authentication
        </h2>
    </div>
</header>

<div class="container main">
    <div><span>rev.3</span></div>
    <div id="pre-auth-section" style="display:none;">
        <p>This example takes the user through Dropbox's API OAuth flow using
            <code>Dropbox.getAuthenticationUrl()</code> method [<a
                    href="http://dropbox.github.io/dropbox-sdk-js/Dropbox.html#getAuthenticationUrl">docs</a>] and then
            uses the generated access token to list the contents of their root directory.</p>
        <a href="" id="authlink" class="button">Authenticate</a>
        <p class="info">Once authenticated, it will use the access token to list the files in your root directory.
        </p>
    </div>

    <div id="authed-section" style="display:none;">
        <p>You have successfully authenticated. Below are the contents of your root directory. They were fetched
            using the SDK and access token.</p>
        <ul id="files"></ul>
    </div>
</div>

<script>
  // ---
  // app key
  var ZTYR_CLIENT_ID = 'wcxza76xbwxv0aj';
  var ZTYR_REDIRECT_URI = 'https://surrsoft.github.io/ztyr/';

  // --- utils
  function parseQueryString(str) {
    var ret = Object.create(null);

    if (typeof str !== 'string') {
      return ret;
    }

    str = str.trim().replace(/^(\?|#|&)/, '');

    if (!str) {
      return ret;
    }

    str.split('&').forEach(function (param) {
      var parts = param.replace(/\+/g, ' ').split('=');
      // Firefox (pre 40) decodes `%3D` to `=`
      // https://github.com/sindresorhus/query-string/pull/37
      var key = parts.shift();
      var val = parts.length > 0 ? parts.join('=') : undefined;

      key = decodeURIComponent(key);

      // missing `=` should be `null`:
      // http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
      val = val === undefined ? null : decodeURIComponent(val);

      if (ret[key] === undefined) {
        ret[key] = val;
      } else if (Array.isArray(ret[key])) {
        ret[key].push(val);
      } else {
        ret[key] = [ret[key], val];
      }
    });

    return ret;
  }

  // Парсит URL и получает их него access token если он есть в urls hash
  // Parses the url and gets the access token if it is in the urls hash
  function getAccessTokenFromUrl() {
    return parseQueryString(window.location.hash).access_token;
  }

  // Если пользователь просто перенаправлен с аутентификации, urls hash будет содержать access token
  // If the user was just redirected from authenticating, the urls hash will contain the access token.
  function isAuthenticated() {
    return !!getAccessTokenFromUrl();
  }

  // Наполнение элементами #files
  // Render a list of items to #files
  function renderItems(items) {
    var filesContainer = document.getElementById('files');
    items.forEach(function (item) {
      var li = document.createElement('li');
      li.innerHTML = item.name;
      filesContainer.appendChild(li);
    });
  }

  // This example keeps both the authenticate and non-authenticated setions
  // in the DOM and uses this function to show/hide the correct section.
  function showPageSection(elementId) {
    document.getElementById(elementId).style.display = 'block';
  }

  if (isAuthenticated()) {
    showPageSection('authed-section');
    console.log('REV*', '8'); // del+

    var accessToken = getAccessTokenFromUrl();
    console.log('!!-!!-!! accessToken {200321213403}\n', accessToken); //del+
    var filePath = JSON.stringify({ path: '/tmp.txt' });

    fetch('https://content.dropboxapi.com/2/files/download', {
      method: 'POST',
      // mode: 'cors',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Dropbox-API-Arg': filePath,
        // 'Origin:': ZTYR_REDIRECT_URI,
      }
    })
      .then(function (response) {
        console.log('response', response);
      })
      .catch(function (err) {
        console.log('ERR*', err);
      });

    // Create an instance of Dropbox with the access token and use it to
    // fetch and render the files in the users root directory.
    // var dbx = new Dropbox.Dropbox({accessToken: accessToken, fetch: fetch});
    // // ---
    // dbx.filesDownload({path: '/tmp.txt'})
    //     .then(function (filesFileMetadata) {
    //         console.log('filesFileMetadata', filesFileMetadata); // del+
    //         var binary = filesFileMetadata.fileBlob;
    //         console.log('!!-!!-!! binary {200321203743}\n', binary); //del+
    //         var binary2 = filesFileMetadata.fileBinary;
    //         console.log('!!-!!-!! binary2 {200321205037}\n', binary2); //del
    //
    //         // // здесь 'binary' обозначает кодировку 'latin-1'
    //         // var buff = new Buffer(binary, 'binary');
    //         // // получение в кодировке 'ucs2'
    //         // var stBuff = buff.toString('ucs2');
    //         // //
    //         // console.log('INFO*', stBuff); // del+
    //     })
    //     .catch(function (filesDownloadError) {
    //         console.log('ERR*', filesDownloadError);
    //     })
    //
    // // ---
    // // dbx.filesListFolder({ path: '' })
    // //     .then(function (response) {
    // //         renderItems(response.entries);
    // //     })
    // //     .catch(function (error) {
    // //         console.error(error);
    // //     });
  } else {
    showPageSection('pre-auth-section');

    // Set the login anchors href using dbx.getAuthenticationUrl()
    var dbx = new Dropbox.Dropbox({ clientId: ZTYR_CLIENT_ID });
    var authUrl = dbx.getAuthenticationUrl(ZTYR_REDIRECT_URI);
    document.getElementById('authlink').href = authUrl;
  }
</script>
</body>

</html>
